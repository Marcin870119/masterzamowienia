<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytor Oferty z Importem CSV</title>
    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        input[type="text"] { width: 100%; font-size: 1.2em; padding: 5px; }
        .red-text { color: red; font-size: 1.2em; font-weight: bold; }
        #banner-preview { max-width: 300px; margin: 10px auto; display: block; }
        .product-image-preview { max-width: 100px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@2.0.9/dist/bwip-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>

<h1>Edytor Oferty z Importem CSV</h1>

<label for="bannerInput">Wybierz baner na górę strony: </label>
<input type="file" id="bannerInput" accept="image/*">
<img id="banner-preview" src="" alt="Podgląd baneru">
<br>

<label for="expiryDate">Oferta ważna do: </label>
<input type="text" id="expiryDate" placeholder="Wpisz datę (np. 31.12.2024)">
<br><br>
<label for="searchInput">Szukaj produktu: </label>
<input type="text" id="searchInput" placeholder="Wpisz nazwę lub indeks produktu">
<br><br>
<input type="file" id="fileInput" accept=".csv">
<table>
    <thead>
        <tr>
            <th>Wybierz</th>
            <th>Index</th>
            <th>Nazwa Produktu</th>
            <th>Cena Netto</th>
            <th>EAN</th>
            <th>Kod Kreskowy</th>
            <th>Zdjęcie</th>
        </tr>
    </thead>
    <tbody id="product-list">
        <!-- Wiersze zostaną dodane przez JavaScript -->
    </tbody>
</table>

<button onclick="generatePDF()">Zapisz do PDF</button>

<script>
    let bannerDataURL = '';

    document.getElementById('bannerInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            bannerDataURL = e.target.result;
            document.getElementById('banner-preview').src = bannerDataURL;
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('fileInput').addEventListener('change', loadCSV);
    document.getElementById('searchInput').addEventListener('input', filterProducts);

    function loadCSV(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            const separator = csv.includes(';') ? ';' : ',';
            const rows = csv.split('\n');
            rows.forEach((row, index) => {
                if (index === 0) return;
                const cols = row.split(separator);
                if (cols.length >= 4) {
                    const product = {
                        index: cols[0].trim(),
                        name: cols[1].trim(),
                        netto: cols[2].trim(),
                        ean: cols[3].trim(),
                        imageDataURL: ''
                    };
                    addProductToTable(product);
                }
            });
        };
        reader.onerror = function() {
            console.error("Błąd wczytywania pliku CSV");
            alert("Wystąpił błąd podczas wczytywania pliku CSV.");
        };
        reader.readAsText(file);
    }

    function addProductToTable(product) {
        const tbody = document.getElementById("product-list");
        const row = document.createElement("tr");
        row.className = "product-row";

        const checkboxCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "product-checkbox";
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        const indexCell = document.createElement("td");
        indexCell.innerText = product.index;
        row.appendChild(indexCell);

        const nameCell = document.createElement("td");
        nameCell.innerText = product.name;
        row.appendChild(nameCell);

        const nettoCell = document.createElement("td");
        const nettoInput = document.createElement("input");
        nettoInput.type = "text";
        nettoInput.value = product.netto;
        nettoInput.classList.add("red-text");
        nettoCell.appendChild(nettoInput);
        row.appendChild(nettoCell);

        const eanCell = document.createElement("td");
        eanCell.innerText = product.ean;
        row.appendChild(eanCell);

        const barcodeCell = document.createElement("td");
        const barcodeCanvas = document.createElement("canvas");
        barcodeCanvas.id = `barcode-${product.ean}`;
        barcodeCell.appendChild(barcodeCanvas);
        row.appendChild(barcodeCell);

        try {
            bwipjs.toCanvas(barcodeCanvas, {
                bcid: 'ean13',
                text: product.ean,
                scale: 2,
                height: 10,
                includetext: false,
                textxalign: 'center',
            });
        } catch (error) {
            console.error("Błąd generowania kodu kreskowego dla EAN:", product.ean, error);
        }

        const imageCell = document.createElement("td");
        const imageInput = document.createElement("input");
        imageInput.type = "file";
        imageInput.accept = "image/*";
        imageInput.onchange = function(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                product.imageDataURL = e.target.result;
                const imgPreview = document.createElement("img");
                imgPreview.src = product.imageDataURL;
                imgPreview.className = "product-image-preview";
                imageCell.appendChild(imgPreview);
            };
            reader.readAsDataURL(file);
        };
        imageCell.appendChild(imageInput);
        row.appendChild(imageCell);

        tbody.appendChild(row);
    }

    function filterProducts() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll(".product-row").forEach(row => {
            const indexText = row.cells[1].innerText.toLowerCase();
            const nameText = row.cells[2].innerText.toLowerCase();
            
            if (indexText.includes(searchTerm) || nameText.includes(searchTerm)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    function generatePDF() {
        // Implementacja generowania PDF
    }
</script>

</body>
</html>
